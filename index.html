<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QR AR Web App</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
    #video { display: none; }
  </style>
</head>
<body>

<video id="video" autoplay></video>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js';
import jsQR from 'https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js';

let camera, scene, renderer;
let spawnPlane;
let video, videoCanvas, videoContext;
let spawned = false;

init();
animate();

async function init() {
  // --- Setup Three.js ---
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera();
  renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  // --- Load replacement image ---
  const loader = new THREE.TextureLoader();
  const texture = loader.load('assets/spawn.jpg');

  const geometry = new THREE.PlaneGeometry(0.4, 0.4); // adjust size in meters
  const material = new THREE.MeshBasicMaterial({ map: texture, side: THREE.DoubleSide });
  spawnPlane = new THREE.Mesh(geometry, material);
  spawnPlane.visible = false; // hidden until QR is detected
  scene.add(spawnPlane);

  // --- Setup video feed ---
  video = document.getElementById('video');
  const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
  video.srcObject = stream;

  videoCanvas = document.createElement('canvas');
  videoContext = videoCanvas.getContext('2d');
}

function animate() {
  requestAnimationFrame(animate);
  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    detectQR();
  }
  renderer.render(scene, camera);
}

function detectQR() {
  // --- Draw video frame to hidden canvas ---
  videoCanvas.width = video.videoWidth;
  videoCanvas.height = video.videoHeight;
  videoContext.drawImage(video, 0, 0, videoCanvas.width, videoCanvas.height);

  const imageData = videoContext.getImageData(0, 0, videoCanvas.width, videoCanvas.height);
  const code = jsQR(imageData.data, imageData.width, imageData.height);

  if (code && !spawned) {
    // QR detected first time
    spawned = true;
    spawnPlane.visible = true;

    // --- Compute center of QR in normalized device coordinates ---
    const cx = (code.location.topLeftCorner.x + code.location.bottomRightCorner.x) / 2;
    const cy = (code.location.topLeftCorner.y + code.location.bottomRightCorner.y) / 2;

    // Convert 2D camera coords to Three.js 3D coordinates
    const x = (cx / video.videoWidth) * 2 - 1;
    const y = -((cy / video.videoHeight) * 2 - 1);

    const vector = new THREE.Vector3(x, y, -0.5); // place 0.5 units in front of camera
    vector.unproject(camera);
    spawnPlane.position.copy(vector);
    spawnPlane.lookAt(camera.position); // optional: face camera
  }
}
</script>

</body>
</html>
