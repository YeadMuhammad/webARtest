<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WebXR Image AR</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
  </style>
</head>
<body>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js';
import { ARButton } from 'https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/webxr/ARButton.js';

let camera, scene, renderer;
let reticle, spawnPlane;
let xrSession, xrReferenceSpace, anchorCreated = false;

init();
animate();

async function init() {
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera();

  renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  document.body.appendChild(renderer.domElement);

  // ARButton to start WebXR session
  document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ['image-tracking', 'anchors', 'local-floor'] }));

  // Load spawn image as texture
  const textureLoader = new THREE.TextureLoader();
  const spawnTexture = textureLoader.load('assets/spawn.jpg');

  const planeGeometry = new THREE.PlaneGeometry(0.2, 0.2); // size in meters
  const planeMaterial = new THREE.MeshBasicMaterial({ map: spawnTexture, side: THREE.DoubleSide });
  spawnPlane = new THREE.Mesh(planeGeometry, planeMaterial);
  spawnPlane.visible = false; // hide until poster is detected
  scene.add(spawnPlane);

  // Wait for session to start
  renderer.xr.addEventListener('sessionstart', async () => {
    xrSession = renderer.xr.getSession();
    xrReferenceSpace = await xrSession.requestReferenceSpace('local-floor');

    // Load poster image for tracking
    const img = await fetch('assets/poster.jpg').then(r => r.blob()).then(b => createImageBitmap(b));
    await xrSession.updateTrackedImages([{ image: img, widthInMeters: 0.2 }]);

    xrSession.addEventListener('trackedevent', async (event) => {
      const imageIndex = event.index;
      const imageState = event.result;

      if (imageState.tracking && !anchorCreated) {
        // Create anchor at the detected poster
        const pose = event.getPose(xrReferenceSpace);
        if (!pose) return;

        const anchor = await xrSession.requestAnchor(pose.transform, xrReferenceSpace);
        spawnPlane.visible = true;
        anchor.context = spawnPlane;

        anchor.addEventListener('update', (e) => {
          // update spawnPlane to anchor transform
          const t = e.anchor.transform;
          spawnPlane.position.set(t.position.x, t.position.y, t.position.z);
          spawnPlane.quaternion.set(t.orientation.x, t.orientation.y, t.orientation.z, t.orientation.w);
        });

        anchorCreated = true;
      }
    });
  });
}

function animate() {
  renderer.setAnimationLoop(render);
}

function render() {
  renderer.render(scene, camera);
}
</script>

</body>
</html>
