<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NFT AR Poster Replacement</title>
  <script src="https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/three.js/build/ar-nft.js"></script>
  <style>
    body { margin:0; overflow:hidden; background:#000; font-family:Arial,sans-serif; }
    #status { position:absolute; top:10px; left:50%; transform:translateX(-50%);
              background:rgba(0,0,0,0.6); color:#fff; padding:8px 12px; border-radius:6px; z-index:10; }
  </style>
</head>
<body>
  <div id="status">Loading AR — allow camera access</div>

  <script>
    const NFT_BASE = 'old'; // base name of your NFT files: old.fset, old.fset3, old.iset
    const REPLACEMENT_IMAGE = 'new.jpg';

    let scene, camera, renderer;
    let arSource, arContext;
    let markerRoot, posterMesh;

    // --- Three.js scene ---
    scene = new THREE.Scene();
    camera = new THREE.Camera();
    scene.add(camera);

    renderer = new THREE.WebGLRenderer({ alpha:true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.domElement.style.position = 'absolute';
    renderer.domElement.style.top = '0px';
    renderer.domElement.style.left = '0px';
    document.body.appendChild(renderer.domElement);

    // --- AR source ---
    arSource = new THREEx.ArToolkitSource({ sourceType: 'webcam' });
    arSource.init(() => onResize());
    window.addEventListener('resize', () => onResize());

    function onResize(){
      arSource.onResizeElement();
      arSource.copyElementSizeTo(renderer.domElement);
      if(arContext && arContext.arController){
        arSource.copyElementSizeTo(arContext.arController.canvas);
      }
    }

    // --- AR context ---
    arContext = new THREEx.ArToolkitContext({
      cameraParametersUrl: 'https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/three.js/data/camera_para.dat',
      detectionMode: 'mono',
    });

    arContext.init(() => camera.projectionMatrix.copy(arContext.getProjectionMatrix()));

    // --- Marker root ---
    markerRoot = new THREE.Group();
    scene.add(markerRoot);

    new THREEx.ArNftControls(arContext, markerRoot, NFT_BASE, {
      changeMatrixMode: 'modelViewMatrix',
      onUpdate: function(isDetected){
        if(isDetected){
          document.getElementById('status').innerText = 'Marker detected — poster ready';
        } else {
          document.getElementById('status').innerText = 'Looking for marker...';
        }
      }
    });

    // --- Replacement plane ---
    const loader = new THREE.TextureLoader();
    loader.load(REPLACEMENT_IMAGE, function(texture){
      const geometry = new THREE.PlaneGeometry(1,1);
      const material = new THREE.MeshBasicMaterial({ map: texture, side: THREE.DoubleSide });
      posterMesh = new THREE.Mesh(geometry, material);
      posterMesh.rotation.x = 0;
      posterMesh.rotation.y = 0;
      posterMesh.position.set(0,0,0);
      posterMesh.scale.set(1,1,1); // adjust as needed
      markerRoot.add(posterMesh);
    }, undefined, function(err){
      console.error('Failed to load replacement image', err);
      document.getElementById('status').innerText = 'Failed to load replacement image';
    });

    // --- Render loop ---
    function animate(){
      requestAnimationFrame(animate);
      if(arSource.ready) arContext.update(arSource.domElement);
      renderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>
