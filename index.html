<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QR AR Web App (GitHub Pages Fix)</title>
  <style>
    body { margin: 0; overflow: hidden; background: #000; }
    canvas { display: block; }
    #video { display: none; }
    #status {
      position: absolute;
      top: 10px;
      left: 10px;
      color: lime;
      font-family: monospace;
      background: rgba(0,0,0,0.6);
      padding: 6px;
      border-radius: 5px;
      z-index: 10;
    }
    #startBtn {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 12px 24px;
      font-size: 18px;
      background: lime;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      z-index: 11;
    }
  </style>
</head>
<body>

<div id="status">Waiting to start...</div>
<button id="startBtn">Start AR</button>
<video id="video" autoplay playsinline></video>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js';
import jsQR from 'https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js';

let camera, scene, renderer;
let spawnPlane;
let video, videoCanvas, videoContext;
let spawned = false;
const statusDiv = document.getElementById('status');
const startBtn = document.getElementById('startBtn');

startBtn.addEventListener('click', () => {
  startBtn.style.display = 'none';
  init().catch(err => {
    console.error(err);
    statusDiv.textContent = "Init error: " + err;
  });
  animate();
});

async function init() {
  statusDiv.textContent = "Setting up Three.js...";
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 10);
  renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  // Load replacement image
  const loader = new THREE.TextureLoader();
  const texture = loader.load('assets/spawn.jpg',
    () => { statusDiv.textContent = "Texture loaded, requesting camera..."; },
    undefined,
    err => { statusDiv.textContent = "Texture load error: " + err; }
  );

  const geometry = new THREE.PlaneGeometry(0.4, 0.4);
  const material = new THREE.MeshBasicMaterial({ map: texture, side: THREE.DoubleSide });
  spawnPlane = new THREE.Mesh(geometry, material);
  spawnPlane.visible = false;
  scene.add(spawnPlane);

  // Request camera with user interaction
  try {
    video = document.getElementById('video');
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    video.srcObject = stream;
    await video.play();
    statusDiv.textContent = "Camera started, looking for QR...";
  } catch (e) {
    statusDiv.textContent = "Camera error: " + e.message;
    console.error(e);
    return;
  }

  videoCanvas = document.createElement('canvas');
  videoContext = videoCanvas.getContext('2d');
}

function animate() {
  requestAnimationFrame(animate);
  if (video && video.readyState === video.HAVE_ENOUGH_DATA) {
    detectQR();
  }
  renderer.render(scene, camera);
}

function detectQR() {
  videoCanvas.width = video.videoWidth;
  videoCanvas.height = video.videoHeight;
  videoContext.drawImage(video, 0, 0, videoCanvas.width, videoCanvas.height);

  const imageData = videoContext.getImageData(0, 0, videoCanvas.width, videoCanvas.height);
  const code = jsQR(imageData.data, imageData.width, imageData.height);

  if (code && !spawned) {
    spawned = true;
    spawnPlane.visible = true;

    const cx = (code.location.topLeftCorner.x + code.location.bottomRightCorner.x) / 2;
    const cy = (code.location.topLeftCorner.y + code.location.bottomRightCorner.y) / 2;

    const x = (cx / video.videoWidth) * 2 - 1;
    const y = -((cy / video.videoHeight) * 2 - 1);

    const vector = new THREE.Vector3(x, y, -0.5);
    vector.unproject(camera);
    spawnPlane.position.copy(vector);
    spawnPlane.lookAt(camera.position);

    statusDiv.textContent = "QR detected: " + code.data;
    console.log("QR detected:", code);
  }
}
</script>

</body>
</html>
